<!DOCTYPE html>
<html lang="vi">
  <style>
    /* Ensure border-box sizing for accurate dimensions */
    #sidebar-container,
    #sidebar-container * {
      box-sizing: border-box !important;
    }

    #sidebar-container {
      position: fixed !important;
      left: 0 !important;
      top: 0 !important;
      width: 256px !important;
      height: 100vh !important;
      overflow: hidden !important;
      z-index: 999 !important;
    }

    #sidebar-container aside {
      position: relative !important;
      left: 0 !important;
      right: 0 !important;
      top: 0 !important;
      margin-left: 0 !important;
      box-sizing: border-box !important;
      width: 256px !important;
      height: 100vh !important;
    }
  </style>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý công việc</title>

    <!-- ✅ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ✅ Font Awesome 6.4.0 - Load with high priority -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- ✅ FullCalendar 6 -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/calendar.css" />
    <link rel="stylesheet" href="assets/css/ai-calendar.css" />
    <link rel="stylesheet" href="assets/css/work.css" />
    <link rel="stylesheet" href="assets/css/ai-modal-fix.css" />
    <link rel="stylesheet" href="assets/css/login.css" />
    <link rel="stylesheet" href="assets/css/salary.css" />

    <style>
      /* ✅ Clean, modern styling */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      /* Loading screen */
      #auth-loading {
        position: fixed;
        inset: 0;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      #main-app {
        display: none;
      }

      #main-app.ready {
        display: block;
      }

      /* ✅ Hide ONLY icon elements until Font Awesome loads */
      body:not(.fa-loaded) i[class*="fa-"],
      body:not(.fa-loaded) span[class*="fa-"] {
        opacity: 0;
      }

      body.fa-loaded i[class*="fa-"],
      body.fa-loaded span[class*="fa-"] {
        opacity: 1;
        transition: opacity 0.2s ease-in-out;
      }

      /* Calendar height */
      #calendar {
        min-height: 600px;
        height: calc(100vh - 200px);
      }

      /* Drag & drop */
      .fc-event-dragging {
        opacity: 0.7;
        cursor: move !important;
      }

      [draggable="true"] {
        cursor: move;
        transition: opacity 0.2s;
      }

      [draggable="true"]:hover {
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <!-- ✅ CRITICAL: Force sidebar visible at page start -->
    <script>
      (function forceSidebarEarly() {
        // Create observer before sidebar is even loaded
        const style = document.createElement("style");
        style.innerHTML = `
          #sidebar-container {
            display: block !important;
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            width: 256px !important;
            min-width: 256px !important;
            height: 100vh !important;
            z-index: 999 !important;
            visibility: visible !important;
            opacity: 1 !important;
          }
          #sidebar-container.hidden,
          #sidebar-container.hidden * {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
          }
        `;
        document.head.appendChild(style);
        console.log("✅ Sidebar force styles injected at page start");
      })();
    </script>

    <div id="auth-loading">
      <div class="text-center">
        <div class="loading-spinner mx-auto"></div>
        <p class="mt-4 text-gray-600">Đang kiểm tra đăng nhập...</p>
      </div>
    </div>

    <div id="main-app" class="flex min-h-screen">
      <!-- Thêm class flex min-h-screen vào đây -->
      <div id="sidebar-container"></div>
      <!-- Sidebar fixed left:0 -->

      <div class="flex-1 flex flex-col" style="margin-left: 256px">
        <!-- Content chính chiếm phần còn lại - shift right by sidebar width -->
        <div class="flex-1 overflow-auto">
          <main id="schedule-section" class="section active"></main>
          <main id="work-section" class="section"></main>
          <main id="ai-section" class="section"></main>
          <main id="salary-section" class="section"></main>
          <main id="profile-section" class="section"></main>
        </div>
      </div>
    </div>

    <div id="createTaskModal" class="modal hidden"></div>
    <div id="settingsModal" class="modal hidden"></div>

    <!-- 1. utils.js - Phải load ĐẦU TIÊN vì mọi thứ dùng nó -->
    <script src="assets/js/utils.js"></script>

    <!-- 2. Các module core khác (nếu có) -->
    <script src="assets/js/modalManager.js"></script>
    <script src="assets/js/AppNavigation.js"></script>
    <script src="assets/js/componentLoader.js"></script>
    <!-- phụ thuộc Utils -->

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <!-- 3. Các module lớn (có thể load song song được) -->
    <script src="assets/js/calendarModule.js"></script>
    <script src="assets/js/workManager.js"></script>
    <script src="assets/js/ai-suggestion-handler.js"></script>
    <script src="assets/js/aiModule.js"></script>
    <script src="assets/js/salaryManager.js"></script>
    <script src="assets/js/tabManager.js"></script>
    <script src="assets/js/profile.js"></script>

    <div id="eventDetailModal" class="modal hidden"></div>
    <div id="aiSuggestionModal" class="modal hidden"></div>
    <div id="createCategoryModal" class="modal hidden"></div>
    <div id="profileModal" class="modal hidden"></div>
    <div id="notificationModal" class="modal hidden"></div>

    <!-- ✅ NEW: Profile & Notification Managers -->
    <script src="assets/js/profileManager.js"></script>
    <script src="assets/js/notificationManager.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- 4. app.js - Phải load CUỐI CÙNG vì nó khởi động toàn bộ app -->
    <script src="assets/js/app.js"></script>

    <!-- ✅ AI Modal Test Helper (Development/Testing) -->
    <script src="assets/js/ai-modal-test-helper.js"></script>

    <!-- ✅ AI Modal CSS Verification (Development/Testing) -->
    <script src="assets/js/ai-modal-css-verify.js"></script>

    <!-- ✅ AI Modal Quick Test (Development/Testing) -->
    <script src="assets/js/ai-modal-quick-test.js"></script>

    <script src="assets/js/modal-force-display.js"></script>

    <script src="assets/js/modal-content-loader.js"></script>

    <script src="assets/js/modal-absolute-fix.js"></script>

    <!-- ✅ DEBUG SIDEBAR LOADING -->
    <script>
      window.debugSidebar = function () {
        const container = document.getElementById("sidebar-container");
        console.log("=== SIDEBAR DEBUG ===");
        console.log("Container exists:", !!container);
        console.log("Container HTML length:", container?.innerHTML.length);
        console.log("Container children count:", container?.children.length);
        console.log(
          "Container innerHTML preview:",
          container?.innerHTML.substring(0, 150)
        );
        const aside = container?.querySelector("aside");
        console.log("Aside element:", !!aside);
        if (aside) {
          const styles = window.getComputedStyle(aside);
          console.log("Aside computed display:", styles.display);
          console.log("Aside computed visibility:", styles.visibility);
          console.log("Aside computed opacity:", styles.opacity);
          console.log(
            "Aside nav children:",
            aside.querySelectorAll("nav button").length
          );
        }
      };

      // Run automatically after page loads
      window.addEventListener("load", () => {
        setTimeout(() => {
          console.log("\n=== AUTO DEBUG AFTER LOAD ===");
          window.debugSidebar();
          // Also check computed styles of #sidebar-container itself
          const container = document.getElementById("sidebar-container");
          const containerStyles = window.getComputedStyle(container);
          console.log("\n=== CONTAINER COMPUTED STYLES ===");
          console.log("Container display:", containerStyles.display);
          console.log("Container position:", containerStyles.position);
          console.log("Container left:", containerStyles.left);
          console.log("Container width:", containerStyles.width);
          console.log("Container z-index:", containerStyles.zIndex);
          console.log("Container visibility:", containerStyles.visibility);
          console.log("Container opacity:", containerStyles.opacity);
          console.log("Container background:", containerStyles.background);
        }, 2000);
      });
    </script>

    <script>
      // ✅ Auth check and Font Awesome wait
      (function () {
        const token = localStorage.getItem("auth_token");
        if (!token) return (location.href = "/login.html");

        try {
          const payload = JSON.parse(atob(token.split(".")[1]));
          if (payload.exp * 1000 < Date.now()) throw new Error("Token expired");

          // ✅ Wait for Font Awesome
          function waitForFA(callback, maxWait = 3000) {
            const start = Date.now();

            function check() {
              // Test if FA renders icons
              const test = document.createElement("i");
              test.className = "fas fa-check";
              test.style.cssText = "position:absolute;left:-9999px;";
              document.body.appendChild(test);

              const style = window.getComputedStyle(test, ":before");
              const loaded =
                style.content &&
                style.content !== "none" &&
                style.content !== '""';

              document.body.removeChild(test);

              if (loaded) {
                console.log("✅ Font Awesome ready");
                document.body.classList.add("fa-loaded");
                callback();
              } else if (Date.now() - start < maxWait) {
                setTimeout(check, 50);
              } else {
                console.warn("⚠️ FA timeout, continuing...");
                document.body.classList.add("fa-loaded");
                callback();
              }
            }

            check();
          }

          // Start app
          waitForFA(() => {
            document.getElementById("auth-loading")?.remove();
            document.getElementById("main-app")?.classList.add("ready");

            function startApp() {
              if (window.App?.init) {
                App.init();
              } else {
                setTimeout(startApp, 100);
              }
            }

            if (document.readyState === "loading") {
              document.addEventListener("DOMContentLoaded", startApp);
            } else {
              startApp();
            }
          });
        } catch (err) {
          console.error("Auth error:", err);
          localStorage.clear();
          location.href = "/login.html";
        }
      })();
    </script>
  </body>
</html>
