<!-- Modal t·∫°o danh m·ª•c m·ªõi -->
<!-- Overlay -->
<div
  class="absolute inset-0 bg-black bg-opacity-50"
  id="categoryModalOverlay"
></div>

<!-- Modal Content -->
<div
  class="relative z-[10051] bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6"
>
  <!-- Header -->
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold text-gray-800">T·∫°o danh m·ª•c m·ªõi</h3>
    <button
      type="button"
      id="closeCategoryModalBtn"
      class="text-gray-400 hover:text-gray-600 transition-colors"
    >
      <i class="fas fa-times text-xl"></i>
    </button>
  </div>

  <!-- Form -->
  <form id="createCategoryForm" class="space-y-4">
    <div>
      <label
        for="newCategoryName"
        class="block text-sm font-medium text-gray-700 mb-1"
      >
        T√™n danh m·ª•c *
      </label>
      <input
        id="newCategoryName"
        type="text"
        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="VD: C√¥ng vi·ªác, H·ªçc t·∫≠p..."
        required
      />
    </div>

    <div>
      <label
        for="newCategoryDesc"
        class="block text-sm font-medium text-gray-700 mb-1"
      >
        M√¥ t·∫£ (t√πy ch·ªçn)
      </label>
      <textarea
        id="newCategoryDesc"
        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        rows="2"
        placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ danh m·ª•c..."
      ></textarea>
    </div>

    <div class="flex justify-end gap-2 pt-2">
      <button
        type="button"
        id="cancelCategoryBtn"
        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
      >
        H·ªßy
      </button>
      <button
        type="submit"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
      >
        T·∫°o danh m·ª•c
      </button>
    </div>
  </form>
</div>

<style>
  /* Create Category Modal Styling */
  #createCategoryModal {
    display: flex;
    align-items: center;
    justify-content: center;
    position: fixed;
    z-index: 10050;
  }

  #createCategoryModal.hidden {
    display: none !important;
  }

  #createCategoryForm .bg-red-50,
  #createCategoryForm .bg-green-50 {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Modal Content Positioning */
  #createCategoryModal .relative {
    position: relative !important;
    max-width: 500px;
    width: 95%;
  }

  #createCategoryModal button[type="submit"] {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transition: all 0.3s ease;
  }

  #createCategoryModal button[type="submit"]:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  }

  #createCategoryModal button[type="submit"]:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  #createCategoryModal input,
  #createCategoryModal textarea {
    transition: all 0.3s ease;
  }

  #createCategoryModal input:focus,
  #createCategoryModal textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
</style>

<script>
  // Setup handlers cho create-category-modal
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("createCategoryForm");
    const closeBtn = document.getElementById("closeCategoryModalBtn");
    const cancelBtn = document.getElementById("cancelCategoryBtn");

    // ==========================================
    // HANDLER: Close button
    // ==========================================
    if (closeBtn) {
      closeBtn.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        closeCategoryModal();
      });
    }

    // ==========================================
    // HANDLER: Cancel button
    // ==========================================
    if (cancelBtn) {
      cancelBtn.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        closeCategoryModal();
      });
    }

    // ==========================================
    // HANDLER: Form submit
    // ==========================================
    if (form) {
      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        e.stopPropagation();

        const nameInput = document.getElementById("newCategoryName");
        const descInput = document.getElementById("newCategoryDesc");
        const submitBtn = form.querySelector('button[type="submit"]');

        if (!nameInput || !nameInput.value.trim()) {
          showCategoryError("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c");
          return;
        }

        const categoryName = nameInput.value.trim();
        const categoryDesc = descInput ? descInput.value.trim() : "";

        // Disable button
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ƒêang t·∫°o...';
        }

        try {
          const token = localStorage.getItem("auth_token");
          if (!token) {
            throw new Error("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc");
          }

          console.log("üì° Creating category:", categoryName);

          const response = await fetch("/api/categories", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              TenLoai: categoryName,
              MoTa: categoryDesc,
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || "L·ªói t·∫°o danh m·ª•c");
          }

          console.log("‚úÖ Category created:", result.data);

          // Th√†nh c√¥ng
          showCategorySuccess("Danh m·ª•c ƒë√£ t·∫°o th√†nh c√¥ng!");

          // Reset form
          form.reset();

          // Reload categories trong create task modal
          if (window.loadCategoriesForModal) {
            console.log("üîÑ Reloading categories in create task modal...");
            await window.loadCategoriesForModal();
          }

          // ƒê√≥ng modal sau 1 gi√¢y
          setTimeout(() => {
            closeCategoryModal();
          }, 1000);
        } catch (error) {
          console.error("‚ùå Error creating category:", error);
          showCategoryError(error.message || "L·ªói t·∫°o danh m·ª•c");
        } finally {
          // Enable button
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = "T·∫°o danh m·ª•c";
          }
        }
      });
    }
  });

  // ==========================================
  // HELPER: Show error
  // ==========================================
  function showCategoryError(message) {
    const form = document.getElementById("createCategoryForm");
    if (!form) return;

    let errorEl = form.querySelector(".category-error-message");
    if (!errorEl) {
      errorEl = document.createElement("div");
      errorEl.className = "category-error-message";
      form.insertBefore(errorEl, form.firstChild);
    }

    errorEl.innerHTML = `
      <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4 rounded text-red-700">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span>${message}</span>
      </div>
    `;

    setTimeout(() => {
      if (errorEl && errorEl.parentNode) {
        errorEl.remove();
      }
    }, 5000);
  }

  // ==========================================
  // HELPER: Show success
  // ==========================================
  function showCategorySuccess(message) {
    const form = document.getElementById("createCategoryForm");
    if (!form) return;

    let successEl = form.querySelector(".category-success-message");
    if (!successEl) {
      successEl = document.createElement("div");
      successEl.className = "category-success-message";
      form.insertBefore(successEl, form.firstChild);
    }

    successEl.innerHTML = `
      <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4 rounded text-green-700">
        <i class="fas fa-check-circle mr-2"></i>
        <span>${message}</span>
      </div>
    `;
  }

  // ==========================================
  // HELPER: Close modal
  // ==========================================
  function closeCategoryModal() {
    const modal = document.getElementById("createCategoryModal");
    if (modal) {
      modal.classList.add("hidden");
      // Clear error/success messages
      const form = document.getElementById("createCategoryForm");
      if (form) {
        const errorEl = form.querySelector(".category-error-message");
        const successEl = form.querySelector(".category-success-message");
        if (errorEl) errorEl.remove();
        if (successEl) successEl.remove();
        form.reset();
      }
      if (window.ModalManager && ModalManager.close) {
        ModalManager.close("createCategoryModal");
      }
    }
  }

  // Expose globally
  window.closeCategoryModal = closeCategoryModal;
</script>
